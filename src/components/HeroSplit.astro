---
import { getLangFromUrl } from '../utils/i18n';

const lang = getLangFromUrl(Astro.url);

interface Slide {
  title: string;
  subtitle: string;
  primaryCta: { text: string; href: string };
  secondaryCta: { text: string; href: string };
  videoSrc: string;
}

interface Props {
  slides?: Slide[];
  // Legacy props for backward compatibility
  title?: string;
  subtitle?: string;
  primaryCta?: { text: string; href: string };
  secondaryCta?: { text: string; href: string };
  imageSrc?: string;
  videoSrcs?: string[];
}

const { 
  slides, 
  // Fallback to legacy props if slides not provided
  title, subtitle, primaryCta, secondaryCta, imageSrc = "https://placehold.co/600x400", videoSrcs 
} = Astro.props;

// Normalize input to slides array
const activeSlides: Slide[] = slides || (videoSrcs && videoSrcs.length > 0 && title && subtitle && primaryCta && secondaryCta ? 
  videoSrcs.map(src => ({ title, subtitle, primaryCta, secondaryCta, videoSrc: src })) : 
  [{ title: title!, subtitle: subtitle!, primaryCta: primaryCta!, secondaryCta: secondaryCta!, videoSrc: '' }] // Fallback for single image/video legacy
);

const hasVideo = slides || (videoSrcs && videoSrcs.length > 0);
---

<section class="relative h-screen min-h-[600px] flex items-center overflow-hidden" id="hero-slider">
  <!-- Background Media Layer -->
  <div class="absolute inset-0 z-0">
    {hasVideo ? (
      activeSlides.map((slide, index) => (
        <video
          src={slide.videoSrc}
          class={`absolute top-0 left-0 w-full h-full object-cover transition-opacity duration-1000 ease-in-out hero-video ${index === 0 ? 'opacity-100' : 'opacity-0'}`}
          autoplay={index === 0}
          muted
          loop
          playsinline
          preload="metadata"
        ></video>
      ))
    ) : (
      <img src={imageSrc} alt="Hero" class="absolute top-0 left-0 w-full h-full object-cover" />
    )}
    <!-- Dark Overlay for Contrast -->
    <div class="absolute inset-0 bg-black/60 z-10"></div>
  </div>

  <!-- Content Layer -->
  <div class="container mx-auto px-4 relative z-20">
    <div class="max-w-3xl">
      {activeSlides.map((slide, index) => (
        <div class={`transition-opacity duration-1000 absolute top-1/2 -translate-y-1/2 left-4 right-4 md:left-auto md:right-auto md:w-full flex flex-col justify-center ${index === 0 ? 'opacity-100 relative pointer-events-auto' : 'opacity-0 absolute pointer-events-none'} slide-text`} data-index={index}>
          <h1 class="text-4xl md:text-5xl lg:text-6xl font-extrabold text-white leading-tight mb-6 drop-shadow-lg">
            {slide.title}
          </h1>
          <p class="text-xl text-gray-200 mb-8 leading-relaxed drop-shadow-md max-w-2xl">
            {slide.subtitle}
          </p>
          <div class="flex flex-col sm:flex-row gap-4 w-full sm:w-auto">
            <a href={import.meta.env.BASE_URL === '/' ? slide.primaryCta.href : `${import.meta.env.BASE_URL}${slide.primaryCta.href.startsWith('/') ? slide.primaryCta.href.slice(1) : slide.primaryCta.href}`} class="inline-flex justify-center items-center px-8 py-3 border border-transparent text-base font-bold rounded-md text-white bg-blue-600 hover:bg-blue-700 md:text-lg transition-colors w-full sm:w-auto shadow-lg">
              {slide.primaryCta.text}
            </a>
            <a href={import.meta.env.BASE_URL === '/' ? slide.secondaryCta.href : `${import.meta.env.BASE_URL}${slide.secondaryCta.href.startsWith('/') ? slide.secondaryCta.href.slice(1) : slide.secondaryCta.href}`} class="inline-flex justify-center items-center px-8 py-3 border-2 border-white text-base font-bold rounded-md text-white hover:bg-white hover:text-blue-900 md:text-lg transition-colors w-full sm:w-auto shadow-lg backdrop-blur-sm bg-white/10">
              {slide.secondaryCta.text}
            </a>
          </div>
        </div>
      ))}
    </div>
  </div>

  <!-- Slider Indicators -->
  {activeSlides.length > 1 && (
    <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex gap-3 z-30">
      {activeSlides.map((_, index) => (
        <button 
          class={`w-3 h-3 rounded-full transition-all duration-300 video-indicator border border-white/50 ${index === 0 ? 'bg-white scale-110' : 'bg-transparent hover:bg-white/30'}`}
          aria-label={`Go to slide ${index + 1}`}
          onclick={`document.dispatchEvent(new CustomEvent('changeSlide', { detail: ${index} }))`}
        ></button>
      ))}
    </div>
  )}
</section>

<script>
  function initHeroSlider() {
    const section = document.getElementById('hero-slider');
    if (!section) return;

    const textSlides = section.querySelectorAll('.slide-text');
    const videoSlides = section.querySelectorAll('.hero-video');
    const indicators = section.querySelectorAll('.video-indicator');
    
    if (textSlides.length <= 1) return;

    let currentIndex = 0;
    const intervalTime = 6000; // 6 seconds per slide
    let intervalId: any;

    // Ensure all videos are muted
    videoSlides.forEach(v => {
      (v as HTMLVideoElement).muted = true;
    });

    const showSlide = (index: number) => {
      // Hide current
      textSlides[currentIndex].classList.remove('opacity-100', 'relative', 'pointer-events-auto');
      textSlides[currentIndex].classList.add('opacity-0', 'absolute', 'pointer-events-none');
      
      videoSlides[currentIndex].classList.remove('opacity-100');
      videoSlides[currentIndex].classList.add('opacity-0');
      (videoSlides[currentIndex] as HTMLVideoElement).pause();

      if (indicators[currentIndex]) {
        indicators[currentIndex].classList.remove('bg-white', 'scale-110');
        indicators[currentIndex].classList.add('bg-transparent');
      }

      // Update index
      currentIndex = index;

      // Show new
      textSlides[currentIndex].classList.remove('opacity-0', 'absolute', 'pointer-events-none');
      textSlides[currentIndex].classList.add('opacity-100', 'relative', 'pointer-events-auto');
      
      videoSlides[currentIndex].classList.remove('opacity-0');
      videoSlides[currentIndex].classList.add('opacity-100');
      const playPromise = (videoSlides[currentIndex] as HTMLVideoElement).play();
      if (playPromise !== undefined) {
          playPromise.catch(e => console.log('Autoplay prevented:', e));
      }

      if (indicators[currentIndex]) {
        indicators[currentIndex].classList.remove('bg-transparent');
        indicators[currentIndex].classList.add('bg-white', 'scale-110');
      }
    };

    const nextSlide = () => {
      const nextIndex = (currentIndex + 1) % textSlides.length;
      showSlide(nextIndex);
    };

    intervalId = setInterval(nextSlide, intervalTime);

    // Allow manual control if needed via custom event (from indicator clicks)
    document.addEventListener('changeSlide', ((e: CustomEvent) => {
      clearInterval(intervalId);
      showSlide(e.detail);
      intervalId = setInterval(nextSlide, intervalTime);
    }) as EventListener);
  }

  // Run on load and view transitions
  document.addEventListener('astro:page-load', initHeroSlider);
  document.addEventListener('DOMContentLoaded', initHeroSlider);
</script>
